<?xml version="1.0" encoding="utf-8" ?>
<odoo>

    <!-- Extend Sale Order Line Tree View -->
    <record id="view_order_line_tree_commission" model="ir.ui.view">
        <field name="name">sale.order.line.list.commission</field>
        <field name="model">sale.order.line</field>
        <field name="inherit_id" ref="sale.view_order_line_tree" />
        <field name="arch" type="xml">
            <xpath expr="//field[@name='price_subtotal']" position="after">
                <field name="product_vendor_id" />
                <field name="purchase_price" optional="hide" />
                <field name="markup_percentage" optional="hide" />
                <field name="commission_amount" optional="hide" />
            </xpath>
        </field>
    </record>

    <!-- Extend Sale Order Form View -->
    <record id="view_order_form_commission" model="ir.ui.view">
        <field name="name">sale.order.form.commission</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form" />
        <field name="arch" type="xml">
            <!-- Add cost and markup summary after sale_order_template_id field -->
            <xpath expr="//group[@name='sale_header']" position="inside">
                <group string="Cost &amp; Markup Summary" name="cost_markup_summary">
                    <field name="total_cost_amount" widget="monetary" />
                    <field name="total_markup_amount" widget="monetary" />
                    <field name="total_markup_percentage" />
                    <field name="total_commission_amount" widget="monetary" />
                </group>
            </xpath>

            <!-- Add commission fields to order lines -->
            <xpath
                expr="//field[@name='order_line']/list//field[@name='price_subtotal']"
                position="after"
            >
                <field name="product_vendor_id" force_save="1" required="1" />
                <field name="commission_factor" optional="hide" />
                <field name="commission_amount" optional="hide" />
                <field name="can_edit_product_vendor" column_invisible="1" />
            </xpath>
        </field>
    </record>

    <!-- Commission Report Tree View -->
    <record id="view_order_tree_commission_report" model="ir.ui.view">
        <field name="name">sale.order.list.commission.report</field>
        <field name="model">sale.order</field>
        <field name="arch" type="xml">
            <list string="Commission Report" create="false" edit="false">
                <field name="name" />
                <field name="date_order" />
                <field name="partner_id" />
                <field name="user_id" />
                <field name="amount_total" sum="Total Amount" />
                <field name="total_cost_amount" sum="Total Cost" />
                <field name="total_markup_amount" sum="Total Markup" />
                <field name="total_markup_percentage" optional="hide" />
                <field name="total_commission_amount" sum="Total Commission" />
                <field name="state" />
            </list>
        </field>
    </record>

    <!-- Commission Report Action -->
    <record id="action_sale_commission_report" model="ir.actions.act_window">
        <field name="name">Commission Report</field>
        <field name="res_model">sale.order</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('state', 'in', ['sale', 'done'])]</field>
        <field name="context">{
            'search_default_salesperson': 1,
            'search_default_confirmed': 1
        }</field>
        <field
            name="view_ids"
            eval="[(5, 0, 0),
            (0, 0, {'view_mode': 'list', 'view_id': ref('view_order_tree_commission_report')}),
            (0, 0, {'view_mode': 'form', 'view_id': ref('sale.view_order_form')})]"
        />
    </record>

    <!-- Add Commission Report to Sales Menu -->
    <menuitem
        id="menu_commission_report"
        name="Commission Report"
        parent="sales_commission_custom.menu_sales_commission_root"
        action="action_sale_commission_report"
        groups="sales_team.group_sale_salesman"
        sequence="20"
    />

    <!-- Commission Report Line Tree View -->
    <record id="view_commission_report_line_tree" model="ir.ui.view">
        <field name="name">sale.order.line.list.commission.report</field>
        <field name="model">sale.order.line</field>
        <field name="arch" type="xml">
            <list
                string="Commission Report Lines"
                editable="bottom"
                create="false"
                edit="true"
            >
                <field name="order_id" string="Order Reference" />
                <field name="order_partner_id" string="Customer" />
                <field name="product_vendor_id" string="Vendor" />
                <field name="product_id" string="Product" />
                <field name="product_uom_qty" string="Quantity" />
                <field name="purchase_price" string="Cost" />
                <field name="price_unit" string="Sale Price" />
                <field name="markup_amount" string="Item Margin" />
                <field name="markup_percentage" string="Markup %" />
                <field name="commission_amount" string="Commission" />
                <field name="commission_payment_status" options="{'clickable': '1'}" />
                <button
                    name="toggle_commission_payment_status"
                    type="object"
                    string="Toggle Status"
                    icon="fa-exchange"
                    invisible="commission_payment_status == 'paid'"
                />
            </list>
        </field>
    </record>

    <!-- Commission Report Line Action -->
    <record id="action_commission_report_line" model="ir.actions.act_window">
        <field name="name">Commission Report Lines</field>
        <field name="res_model">sale.order.line</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[("order_id.state", "in", ["sale", "done"])]</field>
        <field name="context">{}</field>
        <field name="view_id" ref="view_commission_report_line_tree" />
    </record>

    <!-- Add Commission Report Line to Sales Menu -->
    <menuitem
        id="menu_commission_report_line"
        name="Commission Report Lines"
        parent="sales_commission_custom.menu_sales_commission_root"
        action="action_commission_report_line"
        groups="sales_team.group_sale_salesman"
        sequence="30"
    />

</odoo>
